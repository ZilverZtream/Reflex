const e=Symbol.for("rx.m"),t={__proto__:null,Math:Math,Date:Date,Array:Array,Object:Object,Number:Number,String:String,Boolean:Boolean,JSON:JSON,parseInt:parseInt,parseFloat:parseFloat,isNaN:isNaN,isFinite:isFinite,NaN:NaN,Infinity:1/0,true:!0,false:!1,null:null,undefined:void 0},s=Object.assign(Object.create(null),{constructor:1,prototype:1,__defineGetter__:1,__defineSetter__:1,__lookupGetter__:1,__lookupSetter__:1});s.__proto__=1;class i{constructor(){this.pos=0,this.expr=""}compile(e,t){const s=this.parse(e);return(i,r,p)=>{try{return this._evaluate(s,i,r,p,t)}catch(t){return void console.warn("Reflex: Expression evaluation error:",e,t)}}}parse(e){return this.expr=e.trim(),this.pos=0,this.parseExpression()}parseExpression(){return this.parseTernary()}parseTernary(){const e=this.parseOr();if(this.skipWhitespace(),"?"===this.peek()){this.pos++,this.skipWhitespace();const t=this.parseExpression();if(this.skipWhitespace(),":"!==this.peek())throw new Error("Expected ':' in ternary");this.pos++,this.skipWhitespace();return{type:"ternary",condition:e,consequent:t,alternate:this.parseExpression()}}return e}parseOr(){let e=this.parseAnd();for(;this.matchStr("||");)e={type:"binary",op:"||",left:e,right:this.parseAnd()};return e}parseAnd(){let e=this.parseNullishCoalescing();for(;this.matchStr("&&");)e={type:"binary",op:"&&",left:e,right:this.parseNullishCoalescing()};return e}parseNullishCoalescing(){let e=this.parseEquality();for(;this.matchStr("??");)e={type:"binary",op:"??",left:e,right:this.parseEquality()};return e}parseEquality(){let e=this.parseComparison();for(;;)if(this.skipWhitespace(),this.matchStr("==="))e={type:"binary",op:"===",left:e,right:this.parseComparison()};else if(this.matchStr("!=="))e={type:"binary",op:"!==",left:e,right:this.parseComparison()};else if(this.matchStr("=="))e={type:"binary",op:"==",left:e,right:this.parseComparison()};else{if(!this.matchStr("!="))break;e={type:"binary",op:"!=",left:e,right:this.parseComparison()}}return e}parseComparison(){let e=this.parseAdditive();for(;;)if(this.skipWhitespace(),this.matchStr("<="))e={type:"binary",op:"<=",left:e,right:this.parseAdditive()};else if(this.matchStr(">="))e={type:"binary",op:">=",left:e,right:this.parseAdditive()};else if("<"===this.peek()&&"<"!==this.expr[this.pos+1])this.pos++,e={type:"binary",op:"<",left:e,right:this.parseAdditive()};else{if(">"!==this.peek()||">"===this.expr[this.pos+1])break;this.pos++,e={type:"binary",op:">",left:e,right:this.parseAdditive()}}return e}parseAdditive(){let e=this.parseMultiplicative();for(;;)if(this.skipWhitespace(),"+"===this.peek())this.pos++,e={type:"binary",op:"+",left:e,right:this.parseMultiplicative()};else{if("-"!==this.peek())break;this.pos++,e={type:"binary",op:"-",left:e,right:this.parseMultiplicative()}}return e}parseMultiplicative(){let e=this.parseUnary();for(;;)if(this.skipWhitespace(),"*"===this.peek())this.pos++,e={type:"binary",op:"*",left:e,right:this.parseUnary()};else if("/"===this.peek())this.pos++,e={type:"binary",op:"/",left:e,right:this.parseUnary()};else{if("%"!==this.peek())break;this.pos++,e={type:"binary",op:"%",left:e,right:this.parseUnary()}}return e}parseUnary(){return this.skipWhitespace(),"!"===this.peek()?(this.pos++,{type:"unary",op:"!",arg:this.parseUnary()}):"-"!==this.peek()||this.isDigit(this.expr[this.pos+1])?this.matchStr("typeof ")?{type:"unary",op:"typeof",arg:this.parseUnary()}:this.parsePostfix():(this.pos++,{type:"unary",op:"-",arg:this.parseUnary()})}parsePostfix(){let e=this.parsePrimary();for(;;)if(this.skipWhitespace(),"."===this.peek()){this.pos++,this.skipWhitespace();const t=this.parseIdentifier();if(!t)throw new Error("Expected property name after '.'");e={type:"member",object:e,property:t,computed:!1}}else if("["===this.peek()){this.pos++;const t=this.parseExpression();if(this.skipWhitespace(),"]"!==this.peek())throw new Error("Expected ']'");this.pos++,e={type:"member",object:e,property:t,computed:!0}}else{if("("!==this.peek())break;this.pos++;e={type:"call",callee:e,arguments:this.parseArguments()}}return e}parseArguments(){const e=[];if(this.skipWhitespace(),")"!==this.peek())for(e.push(this.parseExpression());","===this.peek();)this.pos++,e.push(this.parseExpression());if(")"!==this.peek())throw new Error("Expected ')'");return this.pos++,e}parsePrimary(){this.skipWhitespace();const e=this.peek();if("("===e){this.pos++;const e=this.parseExpression();if(this.skipWhitespace(),")"!==this.peek())throw new Error("Expected ')'");return this.pos++,e}if("["===e){this.pos++;const e=[];if(this.skipWhitespace(),"]"!==this.peek())for(e.push(this.parseExpression());","===this.peek()&&(this.pos++,this.skipWhitespace(),"]"!==this.peek());)e.push(this.parseExpression());if("]"!==this.peek())throw new Error("Expected ']'");return this.pos++,{type:"array",elements:e}}if("{"===e){this.pos++;const e=[];if(this.skipWhitespace(),"}"!==this.peek())for(e.push(this.parseObjectProperty());","===this.peek()&&(this.pos++,this.skipWhitespace(),"}"!==this.peek());)e.push(this.parseObjectProperty());if("}"!==this.peek())throw new Error("Expected '}'");return this.pos++,{type:"object",properties:e}}if('"'===e||"'"===e||"`"===e)return this.parseString();if(this.isDigit(e)||"-"===e&&this.isDigit(this.expr[this.pos+1]))return this.parseNumber();const t=this.parseIdentifier();if(t)return"true"===t?{type:"literal",value:!0}:"false"===t?{type:"literal",value:!1}:"null"===t?{type:"literal",value:null}:"undefined"===t?{type:"literal",value:void 0}:"NaN"===t?{type:"literal",value:NaN}:"Infinity"===t?{type:"literal",value:1/0}:{type:"identifier",name:t};throw new Error("Unexpected token: "+e)}parseObjectProperty(){let e;if(this.skipWhitespace(),'"'===this.peek()||"'"===this.peek())e=this.parseString().value;else{if("["===this.peek()){if(this.pos++,e=this.parseExpression(),this.skipWhitespace(),"]"!==this.peek())throw new Error("Expected ']'");if(this.pos++,this.skipWhitespace(),":"!==this.peek())throw new Error("Expected ':'");this.pos++;return{computed:!0,key:e,value:this.parseExpression()}}e=this.parseIdentifier()}if(this.skipWhitespace(),":"===this.peek()){this.pos++;return{computed:!1,key:e,value:this.parseExpression()}}return{computed:!1,key:e,value:{type:"identifier",name:e},shorthand:!0}}parseString(){const e=this.peek();this.pos++;let t="";for(;this.pos<this.expr.length&&this.peek()!==e;)if("\\"===this.peek()){this.pos++;const s=this.peek();t+="n"===s?"\n":"t"===s?"\t":"r"===s?"\r":"\\"===s?"\\":s===e?e:s,this.pos++}else t+=this.peek(),this.pos++;if(this.peek()!==e)throw new Error("Unterminated string");return this.pos++,{type:"literal",value:t}}parseNumber(){let e="";for("-"===this.peek()&&(e+="-",this.pos++);this.isDigit(this.peek());)e+=this.peek(),this.pos++;if("."===this.peek())for(e+=".",this.pos++;this.isDigit(this.peek());)e+=this.peek(),this.pos++;if("e"===this.peek()||"E"===this.peek())for(e+=this.peek(),this.pos++,"+"!==this.peek()&&"-"!==this.peek()||(e+=this.peek(),this.pos++);this.isDigit(this.peek());)e+=this.peek(),this.pos++;return{type:"literal",value:parseFloat(e)}}parseIdentifier(){const e=this.pos;if(!this.isIdentStart(this.peek()))return null;for(;this.isIdentPart(this.peek());)this.pos++;return this.expr.slice(e,this.pos)}skipWhitespace(){for(;this.pos<this.expr.length&&/\s/.test(this.peek());)this.pos++}peek(){return this.expr[this.pos]}matchStr(e){return this.skipWhitespace(),this.expr.slice(this.pos,this.pos+e.length)===e&&(this.pos+=e.length,!0)}isDigit(e){return e>="0"&&e<="9"}isIdentStart(e){return e&&/[a-zA-Z_$]/.test(e)}isIdentPart(e){return e&&/[\w$]/.test(e)}_evaluate(i,r,p,a,h){if(i)switch(i.type){case"literal":return i.value;case"identifier":{const o=i.name;if(s[o])return void console.warn("Reflex: Blocked access to unsafe property:",o);if("$event"===o)return a;if(p&&o in p){const t=p[e]||h._mf.get(p);return t&&h._tk(t,o),p[o]}return r&&o in r?r[o]:o in t?t[o]:void 0}case"member":{const t=this._evaluate(i.object,r,p,a,h);if(null==t)return;const o=i.computed?this._evaluate(i.property,r,p,a,h):i.property;if(s[o])return void console.warn("Reflex: Blocked access to unsafe property:",o);const n=t[e]||h._mf.get(t);return n&&h._tk(n,o),t[o]}case"call":{let e,t;if("member"===i.callee.type){if(t=this._evaluate(i.callee.object,r,p,a,h),null==t)return;e=t[i.callee.computed?this._evaluate(i.callee.property,r,p,a,h):i.callee.property]}else e=this._evaluate(i.callee,r,p,a,h),t=void 0;if("function"!=typeof e)return;const s=i.arguments.map(e=>this._evaluate(e,r,p,a,h));return e.apply(t,s)}case"binary":{const e=()=>this._evaluate(i.left,r,p,a,h),t=()=>this._evaluate(i.right,r,p,a,h);switch(i.op){case"+":return e()+t();case"-":return e()-t();case"*":return e()*t();case"/":return e()/t();case"%":return e()%t();case"===":return e()===t();case"!==":return e()!==t();case"==":return e()==t();case"!=":return e()!=t();case"<":return e()<t();case">":return e()>t();case"<=":return e()<=t();case">=":return e()>=t();case"&&":return e()&&t();case"||":return e()||t();case"??":{const s=e();return null!=s?s:t()}default:return}}case"unary":{const e=this._evaluate(i.arg,r,p,a,h);switch(i.op){case"!":return!e;case"-":return-e;case"typeof":return typeof e;default:return}}case"ternary":return this._evaluate(i.condition,r,p,a,h)?this._evaluate(i.consequent,r,p,a,h):this._evaluate(i.alternate,r,p,a,h);case"array":return i.elements.map(e=>this._evaluate(e,r,p,a,h));case"object":{const e={};for(const t of i.properties){e[t.computed?this._evaluate(t.key,r,p,a,h):t.key]=this._evaluate(t.value,r,p,a,h)}return e}default:return}}}"undefined"!=typeof module?module.exports={SafeExprParser:i}:window.SafeExprParser=i;