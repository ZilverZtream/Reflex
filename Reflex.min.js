const M=Symbol(),I=Symbol.for("rx.i"),S=Symbol.for("rx.s"),CLEAN=Symbol(),A=1,R=2,Q=4,RES={__proto__:null,true:1,false:1,null:1,undefined:1,NaN:1,Infinity:1,if:1,else:1,for:1,while:1,do:1,switch:1,case:1,break:1,continue:1,return:1,try:1,catch:1,finally:1,throw:1,new:1,delete:1,typeof:1,instanceof:1,in:1,of:1,void:1,await:1,async:1,yield:1,function:1,class:1,extends:1,super:1,this:1,var:1,let:1,const:1,Math:1,Date:1,console:1,window:1,document:1,Array:1,Object:1,Number:1,String:1,Boolean:1,JSON:1,Promise:1,Symbol:1,BigInt:1,Map:1,Set:1,RegExp:1,Error:1,parseInt:1,parseFloat:1,isNaN:1,isFinite:1,$event:1},SAFE_GLOBALS={__proto__:null,Math:Math,Date:Date,Array:Array,Object:Object,Number:Number,String:String,Boolean:Boolean,JSON:JSON,parseInt:parseInt,parseFloat:parseFloat,isNaN:isNaN,isFinite:isFinite,NaN:NaN,Infinity:1/0,true:!0,false:!1,null:null,undefined:void 0},AM={__proto__:null,push:1,pop:1,shift:1,unshift:1,splice:1,sort:1,reverse:1,fill:1,copyWithin:1},REORDER={__proto__:null,splice:1,sort:1,reverse:1,shift:1,unshift:1,fill:1,copyWithin:1},CM={__proto__:null,get:1,has:1,forEach:1,keys:1,values:1,entries:1,set:1,add:1,delete:1,clear:1},ID_RE=/(?:^|[^.\w$])([a-zA-Z_$][\w$]*)/g,UNSAFE_PROPS=Object.assign(Object.create(null),{constructor:1,prototype:1,__defineGetter__:1,__defineSetter__:1,__lookupGetter__:1,__lookupSetter__:1});UNSAFE_PROPS.__proto__=1;const UNSAFE_URL_RE=/^\s*(javascript|vbscript|data):/i,UNSAFE_EXPR_RE=/\[(["'`])constructor\1\]|\[(["'`])__proto__\1\]|\.constructor\s*\(|Function\s*\(/i,escapeHTML=e=>e.replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]));class SimpleCache{constructor(e=1e3){this.max=e,this.cache=new Map}get(e){return this.cache.get(e)}set(e,t){return this.cache.size>=this.max&&this.cache.clear(),this.cache.set(e,t),t}has(e){return this.cache.has(e)}clear(){this.cache.clear()}}class SafeExprParser{constructor(){this.pos=0,this.expr=""}parse(e){return this.expr=e.trim(),this.pos=0,this.parseExpression()}parseExpression(){return this.parseTernary()}parseTernary(){const e=this.parseOr();if(this.skipWhitespace(),"?"===this.peek()){this.pos++,this.skipWhitespace();const t=this.parseExpression();if(this.skipWhitespace(),":"!==this.peek())throw new Error("Expected ':' in ternary");this.pos++,this.skipWhitespace();return{type:"ternary",condition:e,consequent:t,alternate:this.parseExpression()}}return e}parseOr(){let e=this.parseAnd();for(;this.matchStr("||");)e={type:"binary",op:"||",left:e,right:this.parseAnd()};return e}parseAnd(){let e=this.parseNullishCoalescing();for(;this.matchStr("&&");)e={type:"binary",op:"&&",left:e,right:this.parseNullishCoalescing()};return e}parseNullishCoalescing(){let e=this.parseEquality();for(;this.matchStr("??");)e={type:"binary",op:"??",left:e,right:this.parseEquality()};return e}parseEquality(){let e=this.parseComparison();for(;;)if(this.skipWhitespace(),this.matchStr("==="))e={type:"binary",op:"===",left:e,right:this.parseComparison()};else if(this.matchStr("!=="))e={type:"binary",op:"!==",left:e,right:this.parseComparison()};else if(this.matchStr("=="))e={type:"binary",op:"==",left:e,right:this.parseComparison()};else{if(!this.matchStr("!="))break;e={type:"binary",op:"!=",left:e,right:this.parseComparison()}}return e}parseComparison(){let e=this.parseAdditive();for(;;)if(this.skipWhitespace(),this.matchStr("<="))e={type:"binary",op:"<=",left:e,right:this.parseAdditive()};else if(this.matchStr(">="))e={type:"binary",op:">=",left:e,right:this.parseAdditive()};else if("<"===this.peek()&&"<"!==this.expr[this.pos+1])this.pos++,e={type:"binary",op:"<",left:e,right:this.parseAdditive()};else{if(">"!==this.peek()||">"===this.expr[this.pos+1])break;this.pos++,e={type:"binary",op:">",left:e,right:this.parseAdditive()}}return e}parseAdditive(){let e=this.parseMultiplicative();for(;;)if(this.skipWhitespace(),"+"===this.peek())this.pos++,e={type:"binary",op:"+",left:e,right:this.parseMultiplicative()};else{if("-"!==this.peek())break;this.pos++,e={type:"binary",op:"-",left:e,right:this.parseMultiplicative()}}return e}parseMultiplicative(){let e=this.parseUnary();for(;;)if(this.skipWhitespace(),"*"===this.peek())this.pos++,e={type:"binary",op:"*",left:e,right:this.parseUnary()};else if("/"===this.peek())this.pos++,e={type:"binary",op:"/",left:e,right:this.parseUnary()};else{if("%"!==this.peek())break;this.pos++,e={type:"binary",op:"%",left:e,right:this.parseUnary()}}return e}parseUnary(){return this.skipWhitespace(),"!"===this.peek()?(this.pos++,{type:"unary",op:"!",arg:this.parseUnary()}):"-"!==this.peek()||this.isDigit(this.expr[this.pos+1])?this.matchStr("typeof ")?{type:"unary",op:"typeof",arg:this.parseUnary()}:this.parsePostfix():(this.pos++,{type:"unary",op:"-",arg:this.parseUnary()})}parsePostfix(){let e=this.parsePrimary();for(;;)if(this.skipWhitespace(),"."===this.peek()){this.pos++,this.skipWhitespace();const t=this.parseIdentifier();if(!t)throw new Error("Expected property name after '.'");e={type:"member",object:e,property:t,computed:!1}}else if("["===this.peek()){this.pos++;const t=this.parseExpression();if(this.skipWhitespace(),"]"!==this.peek())throw new Error("Expected ']'");this.pos++,e={type:"member",object:e,property:t,computed:!0}}else{if("("!==this.peek())break;this.pos++;e={type:"call",callee:e,arguments:this.parseArguments()}}return e}parseArguments(){const e=[];if(this.skipWhitespace(),")"!==this.peek())for(e.push(this.parseExpression());","===this.peek();)this.pos++,e.push(this.parseExpression());if(")"!==this.peek())throw new Error("Expected ')'");return this.pos++,e}parsePrimary(){this.skipWhitespace();const e=this.peek();if("("===e){this.pos++;const e=this.parseExpression();if(this.skipWhitespace(),")"!==this.peek())throw new Error("Expected ')'");return this.pos++,e}if("["===e){this.pos++;const e=[];if(this.skipWhitespace(),"]"!==this.peek())for(e.push(this.parseExpression());","===this.peek()&&(this.pos++,this.skipWhitespace(),"]"!==this.peek());)e.push(this.parseExpression());if("]"!==this.peek())throw new Error("Expected ']'");return this.pos++,{type:"array",elements:e}}if("{"===e){this.pos++;const e=[];if(this.skipWhitespace(),"}"!==this.peek())for(e.push(this.parseObjectProperty());","===this.peek()&&(this.pos++,this.skipWhitespace(),"}"!==this.peek());)e.push(this.parseObjectProperty());if("}"!==this.peek())throw new Error("Expected '}'");return this.pos++,{type:"object",properties:e}}if('"'===e||"'"===e||"`"===e)return this.parseString();if(this.isDigit(e)||"-"===e&&this.isDigit(this.expr[this.pos+1]))return this.parseNumber();const t=this.parseIdentifier();if(t)return"true"===t?{type:"literal",value:!0}:"false"===t?{type:"literal",value:!1}:"null"===t?{type:"literal",value:null}:"undefined"===t?{type:"literal",value:void 0}:"NaN"===t?{type:"literal",value:NaN}:"Infinity"===t?{type:"literal",value:1/0}:{type:"identifier",name:t};throw new Error("Unexpected token: "+e)}parseObjectProperty(){let e;if(this.skipWhitespace(),'"'===this.peek()||"'"===this.peek())e=this.parseString().value;else{if("["===this.peek()){if(this.pos++,e=this.parseExpression(),this.skipWhitespace(),"]"!==this.peek())throw new Error("Expected ']'");if(this.pos++,this.skipWhitespace(),":"!==this.peek())throw new Error("Expected ':'");this.pos++;return{computed:!0,key:e,value:this.parseExpression()}}e=this.parseIdentifier()}if(this.skipWhitespace(),":"===this.peek()){this.pos++;return{computed:!1,key:e,value:this.parseExpression()}}return{computed:!1,key:e,value:{type:"identifier",name:e},shorthand:!0}}parseString(){const e=this.peek();this.pos++;let t="";for(;this.pos<this.expr.length&&this.peek()!==e;)if("\\"===this.peek()){this.pos++;const s=this.peek();t+="n"===s?"\n":"t"===s?"\t":"r"===s?"\r":"\\"===s?"\\":s===e?e:s,this.pos++}else t+=this.peek(),this.pos++;if(this.peek()!==e)throw new Error("Unterminated string");return this.pos++,{type:"literal",value:t}}parseNumber(){let e="";for("-"===this.peek()&&(e+="-",this.pos++);this.isDigit(this.peek());)e+=this.peek(),this.pos++;if("."===this.peek())for(e+=".",this.pos++;this.isDigit(this.peek());)e+=this.peek(),this.pos++;if("e"===this.peek()||"E"===this.peek())for(e+=this.peek(),this.pos++,"+"!==this.peek()&&"-"!==this.peek()||(e+=this.peek(),this.pos++);this.isDigit(this.peek());)e+=this.peek(),this.pos++;return{type:"literal",value:parseFloat(e)}}parseIdentifier(){const e=this.pos;if(!this.isIdentStart(this.peek()))return null;for(;this.isIdentPart(this.peek());)this.pos++;return this.expr.slice(e,this.pos)}skipWhitespace(){for(;this.pos<this.expr.length&&/\s/.test(this.peek());)this.pos++}peek(){return this.expr[this.pos]}matchStr(e){return this.skipWhitespace(),this.expr.slice(this.pos,this.pos+e.length)===e&&(this.pos+=e.length,!0)}isDigit(e){return e>="0"&&e<="9"}isIdentStart(e){return e&&/[a-zA-Z_$]/.test(e)}isIdentPart(e){return e&&/[\w$]/.test(e)}}function evaluateAST(e,t,s,r,i){if(e)switch(e.type){case"literal":return e.value;case"identifier":{const n=e.name;if(UNSAFE_PROPS[n])return void console.warn("Reflex: Blocked access to unsafe property:",n);if("$event"===n)return r;if(s&&n in s){const e=s[M]||i._mf.get(s);return e&&i._tk(e,n),s[n]}return t&&n in t?t[n]:n in SAFE_GLOBALS?SAFE_GLOBALS[n]:void 0}case"member":{const n=evaluateAST(e.object,t,s,r,i);if(null==n)return;const o=e.computed?evaluateAST(e.property,t,s,r,i):e.property;if(UNSAFE_PROPS[o])return void console.warn("Reflex: Blocked access to unsafe property:",o);const a=n[M]||i._mf.get(n);return a&&i._tk(a,o),n[o]}case"call":{let n,o;if("member"===e.callee.type){if(o=evaluateAST(e.callee.object,t,s,r,i),null==o)return;n=o[e.callee.computed?evaluateAST(e.callee.property,t,s,r,i):e.callee.property]}else n=evaluateAST(e.callee,t,s,r,i),o=void 0;if("function"!=typeof n)return;const a=e.arguments.map(e=>evaluateAST(e,t,s,r,i));return n.apply(o,a)}case"binary":{const n=()=>evaluateAST(e.left,t,s,r,i),o=()=>evaluateAST(e.right,t,s,r,i);switch(e.op){case"+":return n()+o();case"-":return n()-o();case"*":return n()*o();case"/":return n()/o();case"%":return n()%o();case"===":return n()===o();case"!==":return n()!==o();case"==":return n()==o();case"!=":return n()!=o();case"<":return n()<o();case">":return n()>o();case"<=":return n()<=o();case">=":return n()>=o();case"&&":return n()&&o();case"||":return n()||o();case"??":{const e=n();return null!=e?e:o()}default:return}}case"unary":{const n=evaluateAST(e.arg,t,s,r,i);switch(e.op){case"!":return!n;case"-":return-n;case"typeof":return typeof n;default:return}}case"ternary":{const n=evaluateAST(e.condition,t,s,r,i);return evaluateAST(n?e.consequent:e.alternate,t,s,r,i)}case"array":return e.elements.map(e=>evaluateAST(e,t,s,r,i));case"object":{const n={};for(const o of e.properties){n[o.computed?evaluateAST(o.key,t,s,r,i):o.key]=evaluateAST(o.value,t,s,r,i)}return n}default:return}}class Reflex{constructor(e={}){this.s=null,this._e=null,this._es=[],this._q=[],this._p=!1,this._b=0,this._pt=new Map,this._ec=new SimpleCache(1e3),this._mf=new WeakMap,this._dh=new Map,this._dr=null,this._cp=new Map,this._parser=null,this.cfg={sanitize:!0,cspSafe:!1,cacheSize:1e3},this.s=this._r(e);"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.mount(),{once:!0}):queueMicrotask(()=>this.mount())}configure(e){return void 0!==e.sanitize&&(this.cfg.sanitize=e.sanitize),void 0!==e.cspSafe&&(this.cfg.cspSafe=e.cspSafe),void 0!==e.cacheSize&&(this.cfg.cacheSize=e.cacheSize,this._ec=new SimpleCache(e.cacheSize)),void 0!==e.parser&&(this._parser=e.parser),this}_getParser(){return this._parser||(this._parser=new SafeExprParser),this._parser}mount(e=document.body){return this._dr=e,this._bnd(e,null),this._w(e,null),this}component(e,t){const s=document.createElement("template");let r=t.template;return this.cfg.sanitize&&("undefined"!=typeof DOMPurify?r=DOMPurify.sanitize(r,{RETURN_DOM_FRAGMENT:!1,WHOLE_DOCUMENT:!1}):console.warn("Reflex: DOMPurify not loaded. Component templates should be trusted or load DOMPurify for sanitization.")),s.innerHTML=r,this._cp.set(e.toLowerCase(),{_t:s.content.firstElementChild,p:t.props||[],s:t.setup}),this}computed(e){const t=this;let s,r=!0;const i=new Set,n=this._ef(()=>(s=e(t.s),r=!1,s),{lazy:!0,sched:()=>{if(!r){if(r=!0,!i.size)return void t._qj(n);for(const e of i)1&e.f&&!(2&e.f)&&(e.s?e.s(e):t._qj(e))}}});return n(),{get value(){return t._e&&!i.has(t._e)&&(i.add(t._e),t._e.d.push(i)),r&&n(),s}}}watch(e,t,s={}){const r=this,i="function"==typeof e?e:()=>e.value;let n,o;const a=()=>{const e=l();!s.deep&&Object.is(e,n)||(o&&o(),t(e,n,e=>{o=e}),n=s.deep?r._clone(e):e)},l=this._ef(()=>{const e=i();return s.deep&&r._trv(e),e},{lazy:!0,sched:()=>r._qj(a)});return s.immediate?a():(n=l(),s.deep&&(n=this._clone(n))),()=>l.kill()}batch(e){this._b++;try{e()}finally{if(0===--this._b)try{this._fpt()}catch(e){console.error("Reflex: Error during batch flush:",e)}}}nextTick(e){return new Promise(t=>queueMicrotask(()=>{this._fl(),e?.(),t()}))}toRaw(e){if(null===e||"object"!=typeof e)return e;const t=e[M]||this._mf.get(e);return t?t.r:e}clearCache(){return this._ec.clear(),this}_arrHandler(e){const t=this;return{get(s,r,i){if(r===M)return e;if(r===S)return s[S];if("symbol"==typeof r)return Reflect.get(s,r,i);if(AM[r])return e._am||(e._am=Object.create(null)),e._am[r]||(e._am[r]=t._am(s,r,e)),e._am[r];t._tk(e,r);const n=Reflect.get(s,r,i);return t._wrap(n)},set(s,r,i,n){const o=t.toRaw(i),a=s[r];if(Object.is(a,o)&&"length"!==r)return!0;let l,h=!1,p=-1;"string"==typeof r&&(p=Number(r),h=p>=0&&Number.isInteger(p)&&String(p)===r),l="length"===r||(h?p<s.length:r in s);return!!Reflect.set(s,r,o,n)&&(t._tr(e,r),"length"===r?t._tr(e,I):h&&(t._tr(e,I),l||t._tr(e,"length")),!0)},deleteProperty(s,r){if(!(r in s))return!0;const i=Reflect.deleteProperty(s,r);return i&&(t._tr(e,r),t._tr(e,I),t._tr(e,"length")),i}}}_objHandler(e){const t=this;return{get(s,r,i){if(r===M)return e;if(r===S)return s[S];if("symbol"==typeof r)return Reflect.get(s,r,i);t._tk(e,r);const n=Reflect.get(s,r,i);return t._wrap(n)},set(s,r,i,n){const o=t.toRaw(i),a=s[r];if(Object.is(a,o))return!0;const l=r in s;return!!Reflect.set(s,r,o,n)&&(t._tr(e,r),l||t._tr(e,I),!0)},deleteProperty(s,r){if(!(r in s))return!0;const i=Reflect.deleteProperty(s,r);return i&&(t._tr(e,r),t._tr(e,I)),i}}}_colHandler(e,t){const s=this;return{get:(r,i,n)=>i===M?e:i===S?r[S]:"symbol"==typeof i&&i!==Symbol.iterator?Reflect.get(r,i,n):"size"===i?(s._tk(e,I),r.size):i!==Symbol.iterator&&!CM[i]||"function"!=typeof r[i]?(s._tk(e,i),Reflect.get(r,i,n)):s._cm(r,i,e,t),set:(e,t,s,r)=>Reflect.set(e,t,s,r),deleteProperty:(e,t)=>Reflect.deleteProperty(e,t)}}_r(e){if(null===e||"object"!=typeof e)return e;if(e[S])return e;if(e instanceof Node)return e;const t=e[M]||this._mf.get(e);if(t)return t.p;const s={p:null,r:e,d:new Map,ai:!1,_am:null},r=Array.isArray(e),i=e instanceof Map,n=e instanceof Set;let o;return o=r?this._arrHandler(s):i||n?this._colHandler(s,i):this._objHandler(s),s.p=new Proxy(e,o),Object.isExtensible(e)?Object.defineProperty(e,M,{value:s,configurable:!0}):this._mf.set(e,s),s.p}_wrap(e){return null===e||"object"!=typeof e||e[S]||e instanceof Node?e:this._r(e)}_tk(e,t){if(!this._e)return;if(Array.isArray(e.r)&&"string"==typeof t){const s=Number(t);s>=0&&Number.isInteger(s)&&String(s)===t&&(e.ai=!0)}let s=e.d.get(t);s||e.d.set(t,s=new Set),s.has(this._e)||(s.add(this._e),this._e.d.push(s))}_tr(e,t){if(this._b>0){let s=this._pt.get(e);return s||this._pt.set(e,s=new Set),void s.add(t)}const s=e.d.get(t);if(s)for(const e of s)1&e.f&&!(2&e.f)&&(e.s?e.s(e):this._qj(e))}_fpt(){if(!this._pt.size)return;const e=this._pt;this._pt=new Map;for(const[t,s]of e)for(const e of s)try{this._tr(t,e)}catch(t){console.error("Reflex: Error triggering update for key:",e,t)}}_am(e,t,s){const r=this;return function(...i){let n;r._b++;try{n=Array.prototype[t].apply(e,i);let o=r._pt.get(s);if(o||r._pt.set(s,o=new Set),o.add(I),o.add("length"),s.ai&&REORDER[t])for(const[e,t]of s.d)if(t.size){if("string"==typeof e){const t=Number(e);t>=0&&Number.isInteger(t)&&String(t)===e&&o.add(e)}}else s.d.delete(e)}finally{if(0===--r._b)try{r._fpt()}catch(e){console.error("Reflex: Error flushing pending triggers:",e)}}return n}}_cm(e,t,s,r){if(s[t])return s[t];const i=this,n=(r?Map.prototype:Set.prototype)[t];return t===Symbol.iterator||"entries"===t||"values"===t||"keys"===t?s[t]=function(){i._tk(s,I);const o=n.call(e);return{[Symbol.iterator](){return this},next(){const e=o.next();if(e.done)return e;if(r){if("keys"===t||"values"===t)return{done:!1,value:i._wrap(e.value)};const[s,r]=e.value;return{done:!1,value:[i._wrap(s),i._wrap(r)]}}return{done:!1,value:i._wrap(e.value)}},return:e=>o.return?o.return(e):{done:!0,value:e}}}:s[t]="get"===t?t=>{const r=i.toRaw(t);return i._tk(s,r),i._wrap(n.call(e,r))}:"has"===t?t=>{const r=i.toRaw(t);return i._tk(s,r),n.call(e,r)}:"forEach"===t?function(t,r){i._tk(s,I),n.call(e,(e,n)=>t.call(r,i._wrap(e),i._wrap(n),s.p))}:"set"===t?function(t,r){const o=i.toRaw(t),a=i.toRaw(r),l=e.has(o),h=l?e.get(o):void 0;if(n.call(e,o,a),!l||!Object.is(h,a)){i._b++;try{let e=i._pt.get(s);e||i._pt.set(s,e=new Set),e.add(o),e.add(I)}finally{if(0===--i._b)try{i._fpt()}catch(e){console.error("Reflex: Error flushing pending triggers:",e)}}}return s.p}:"add"===t?function(t){const r=i.toRaw(t);if(!e.has(r)){n.call(e,r),i._b++;try{let e=i._pt.get(s);e||i._pt.set(s,e=new Set),e.add(r),e.add(I)}finally{if(0===--i._b)try{i._fpt()}catch(e){console.error("Reflex: Error flushing pending triggers:",e)}}}return s.p}:"delete"===t?t=>{const r=i.toRaw(t),o=e.has(r),a=n.call(e,r);if(o){i._b++;try{let e=i._pt.get(s);e||i._pt.set(s,e=new Set),e.add(r),e.add(I)}finally{if(0===--i._b)try{i._fpt()}catch(e){console.error("Reflex: Error flushing pending triggers:",e)}}}return a}:"clear"===t?()=>{if(e.size){i._b++;try{let t=i._pt.get(s);t||i._pt.set(s,t=new Set),e.forEach((e,s)=>t.add(s)),t.add(I),n.call(e)}finally{if(0===--i._b)try{i._fpt()}catch(e){console.error("Reflex: Error flushing pending triggers:",e)}}}}:function(){return i._tk(s,I),n.call(e)}}_ef(e,t={}){const s=this,r=()=>{if(1&r.f){s._cln_eff(r),s._es.push(s._e),s._e=r,r.f|=2;try{return e()}finally{r.f&=-3,s._e=s._es.pop()}}};return r.f=1,r.d=[],r.s=t.sched||null,r.kill=()=>{s._cln_eff(r),r.f=0},t.lazy||r(),r}_cln_eff(e){for(let t=0;t<e.d.length;t++)e.d[t].delete(e);e.d.length=0}_qj(e){4&e.f||(e.f|=4,this._q.push(e),this._p||(this._p=!0,queueMicrotask(()=>this._fl())))}_fl(){this._p=!1;const e=this._q;this._q=[];for(let t=0;t<e.length;t++){const s=e[t];s.f&=-5;try{s()}catch(e){console.error("Reflex: Error during flush:",e)}}}_reg(e,t){(e[CLEAN]||(e[CLEAN]=[])).push(t)}_kill(e){const t=e[CLEAN];if(t){for(let e=0;e<t.length;e++)try{t[e]()}catch{}e[CLEAN]=null}for(let t=e.firstChild;t;t=t.nextSibling)this._kill(t)}_w(e,t){let s=e.firstChild;for(;s;){const e=s.nextSibling,r=s.nodeType;if(1===r){if(null===s.getAttribute("m-ignore")){const e=s.tagName;if("TEMPLATE"===e);else{if(null!==s.getAttribute("m-if"))this._dir_if(s,t);else{if(null!==s.getAttribute("m-for"))this._dir_for(s,t);else{const r=e.toLowerCase();this._cp.has(r)?this._comp(s,r,t):(this._bnd(s,t),this._w(s,t))}}}}}else if(3===r){const e=s.nodeValue;e&&-1!==e.indexOf("{{")&&this._txt(s,t)}s=e}}_bnd(e,t){const s=e.attributes;if(s)for(let r=s.length-1;r>=0;r--){const i=s[r],n=i.name,o=i.value;n.startsWith(":")?this._at(e,n.slice(1),o,t):n.startsWith("@")?this._ev(e,n.slice(1),o,t):n.startsWith("m-")&&("m-model"===n?this._mod(e,o,t):"m-text"===n?this._at(e,"textContent",o,t):"m-html"===n?this._html(e,o,t):"m-show"===n&&this._show(e,o,t))}}_dir_if(e,t){const s=this._fn(e.getAttribute("m-if")),r=document.createComment("if");let i;e.replaceWith(r);const n=this._ef(()=>{const n=!!s(this.s,t);n&&!i?(i=e.cloneNode(!0),i.removeAttribute("m-if"),r.after(i),this._bnd(i,t),this._w(i,t)):!n&&i&&(this._kill(i),i.remove(),i=null)});this._reg(r,n.kill)}_dir_for(e,t){const s=e.getAttribute("m-for"),r=e.getAttribute("m-key"),i=s.match(/^\s*(.*?)\s+in\s+(.*$)/);if(!i)return;const[n,o,a]=i,l=o.replace(/[()]/g,"").split(",").map(e=>e.trim()),h=l[0],p=l[1],c=this._fn(a),f=!!r&&/^[a-zA-Z_$][\w$]*$/.test(r),u=!r||f?null:this._fn(r),_=document.createComment("for");e.replaceWith(_);const d=e.cloneNode(!0);d.removeAttribute("m-for"),d.removeAttribute("m-key");let y=new Map;const g=this._ef(()=>{const e=c(this.s,t)||[],s=e[M]||this._mf.get(e);s&&this._tk(s,I);const i=Array.isArray(e)?this.toRaw(e):Array.from(e),n=new Map;let o=_;for(let e=0;e<i.length;e++){let s=i[e];null===s||"object"!=typeof s||s[S]||(s=this._r(s));const a=Object.create(t||{});a[h]=s,p&&(a[p]=e);const l=r?f?s&&s[r]:u(this.s,a):e;let c=y.get(l);if(c){const t=c._sc;t[h]=s,p&&(t[p]=e),y.delete(l)}else c=d.cloneNode(!0),c._sc=this._r(a),this._bnd(c,c._sc),this._w(c,c._sc);o.nextSibling!==c&&o.after(c),n.set(l,c),o=c}y.forEach(e=>{this._kill(e),e.remove()}),y=n});this._reg(_,()=>{y.forEach(e=>this._kill(e)),g.kill()})}_txt(e,t){const s=e.nodeValue;if(s.startsWith("{{")&&s.endsWith("}}")&&s.indexOf("{{",2)<0){const r=this._fn(s.slice(2,-2));let i;const n=this._ef(()=>{const s=r(this.s,t),n=null==s?"":String(s);n!==i&&(i=n,e.nodeValue=n)});return void this._reg(e,n.kill)}const r=s.split(/(\{\{.*?\}\})/g).map(e=>e.startsWith("{{")?this._fn(e.slice(2,-2)):e);let i;const n=this._ef(()=>{let s="";for(let e=0;e<r.length;e++){const i=r[e];s+="function"==typeof i?i(this.s,t)??"":i}s!==i&&(i=s,e.nodeValue=s)});this._reg(e,n.kill)}_at(e,t,s,r){const i=this._fn(s);let n;const o="href"===t||"src"===t||"action"===t||"formaction"===t||"xlink:href"===t,a=this._ef(()=>{let s=i(this.s,r);if(o&&null!=s&&"string"==typeof s&&UNSAFE_URL_RE.test(s)&&(console.warn("Reflex: Blocked unsafe URL protocol in",t+":",s),s="about:blank"),"class"===t){const t=this._cls(s);t!==n&&(n=t,e.className=t)}else if("style"===t){const t=this._sty(s);t!==n&&(n=t,e.style.cssText=t)}else if(t in e)e[t]=s??"";else{const r=null===s||!1===s?null:String(s);r!==n&&(n=r,null===r?e.removeAttribute(t):e.setAttribute(t,r))}});this._reg(e,a.kill)}_html(e,t,s){const r=this._fn(t);let i;const n=this._ef(()=>{const t=r(this.s,s);let n=null==t?"":String(t);this.cfg.sanitize&&("undefined"!=typeof DOMPurify?n=DOMPurify.sanitize(n):(n=escapeHTML(n),console.warn("Reflex: DOMPurify not loaded. HTML content escaped for safety. Load DOMPurify for proper sanitization."))),n!==i&&(i=n,e.innerHTML=n)});this._reg(e,n.kill)}_show(e,t,s){const r=this._fn(t),i="none"===e.style.display?"":e.style.display;let n;const o=this._ef(()=>{const t=r(this.s,s)?i:"none";t!==n&&(n=t,e.style.display=t)});this._reg(e,o.kill)}_mod(e,t,s){const r=this._fn(t),i=(e.type||"").toLowerCase(),n="checkbox"===i,o="number"===i||"range"===i,a=this._ef(()=>{const t=r(this.s,s);if(n)e.checked=!!t;else{const s=null==t?"":String(t);e.value!==s&&(e.value=s)}});this._reg(e,a.kill);const l=()=>{let r;r=n?e.checked:o?""===e.value?null:parseFloat(e.value):e.value;const i=t.split("."),a=i.pop();if(UNSAFE_PROPS[a])return void console.warn("Reflex: Blocked attempt to set unsafe property:",a);let l=s&&i[0]in s?s:this.s;for(const e of i){if(UNSAFE_PROPS[e])return void console.warn("Reflex: Blocked attempt to traverse unsafe property:",e);if(null==l[e])l[e]={};else if("object"!=typeof l[e])return void console.warn("Reflex: Cannot set nested property on non-object value at path:",e);l=l[e]}l[a]=r},h=n||"SELECT"===e.tagName?"change":"input";e.addEventListener(h,l),"change"!==h&&e.addEventListener("change",l),this._reg(e,()=>{e.removeEventListener(h,l),e.removeEventListener("change",l)})}_ev(e,t,s,r){const[i,...n]=t.split(".");this._dh.has(i)||(this._dh.set(i,new WeakMap),this._dr.addEventListener(i,e=>this._hdl(e,i))),this._dh.get(i).set(e,{f:this._fn(s,!0),o:r,m:n})}_hdl(e,t){let s=e.target;for(;s&&s!==this._dr;){const r=this._dh.get(t)?.get(s);if(r){const{f:i,o:n,m:o}=r;if(o.includes("self")&&e.target!==s){s=s.parentNode;continue}if(o.includes("prevent")&&e.preventDefault(),o.includes("stop")&&e.stopPropagation(),i(this.s,n,e),o.includes("once")&&this._dh.get(t).delete(s),e.cancelBubble)return}s=s.parentNode}}_fn(e,t){const s=(t?"H:":"")+e,r=this._ec.get(s);if(r)return r;if(UNSAFE_EXPR_RE.test(e))return console.warn("Reflex: Blocked potentially unsafe expression:",e),this._ec.set(s,()=>{});if(!t&&33===e.charCodeAt(0)&&/^![a-z_$][\w$.]*$/i.test(e)){const t=e.slice(1).split(".");for(const e of t)if(UNSAFE_PROPS[e])return console.warn("Reflex: Blocked access to unsafe property:",e),this._ec.set(s,()=>{});const r=this;return this._ec.set(s,(e,s)=>{if(s){const e=s[M]||r._mf.get(s);e&&r._tk(e,t[0])}let i=s&&t[0]in s?s:e;for(const e of t){if(null==i)return!0;i=i[e]}return!i})}if(!t&&/^[a-z_$][\w$.]*$/i.test(e)){const t=e.split(".");for(const e of t)if(UNSAFE_PROPS[e])return console.warn("Reflex: Blocked access to unsafe property:",e),this._ec.set(s,()=>{});const r=this;if(1===t.length){const e=t[0];return this._ec.set(s,(t,s)=>{if(s){const t=s[M]||r._mf.get(s);t&&r._tk(t,e)}return s&&e in s?s[e]:t[e]})}return this._ec.set(s,(e,s)=>{if(s){const e=s[M]||r._mf.get(s);e&&r._tk(e,t[0])}let i=s&&t[0]in s?s:e;for(const e of t){if(null==i)return;i=i[e]}return i})}const i=!t&&/^([a-z_$][\w$]*)\[(\d+)\](\.[\w$.]+)?$/i.exec(e);if(i){const e=i[1],t=parseInt(i[2],10),r=i[3];if(UNSAFE_PROPS[e])return console.warn("Reflex: Blocked access to unsafe property:",e),this._ec.set(s,()=>{});const n=r?r.slice(1).split("."):null;if(n)for(const e of n)if(UNSAFE_PROPS[e])return console.warn("Reflex: Blocked access to unsafe property:",e),this._ec.set(s,()=>{});const o=this;return this._ec.set(s,(s,r)=>{if(r){const t=r[M]||o._mf.get(r);t&&o._tk(t,e)}let i=r&&e in r?r[e]:s[e];if(null==i)return;let a=i[t];if(n)for(const e of n){if(null==a)return;a=a[e]}return a})}if(this.cfg.cspSafe)try{const t=this._getParser().parse(e),r=this;return this._ec.set(s,(s,i,n)=>{try{return evaluateAST(t,s,i,n,r)}catch(t){return void console.warn("Reflex: Expression evaluation error:",e,t)}})}catch(t){return console.warn("Reflex: CSP-safe parse error:",e,t),this._ec.set(s,()=>{})}const n=new Set;let o;for(ID_RE.lastIndex=0;o=ID_RE.exec(e);)!RES[o[1]]&&n.add(o[1]);const a=Array.from(n).map(e=>`var ${e}=(c&&(${JSON.stringify(e)} in c))?c.${e}:s.${e};`).join(""),l=t?`${a}${e};`:`${a}return(${e});`;try{return this._ec.set(s,new Function("s","c","$event",l))}catch(t){return console.warn("Reflex compile error:",e,t),this._ec.set(s,()=>{})}}_trv(e,t=new Set){if(null===e||"object"!=typeof e||t.has(e))return;t.add(e);const s=e[M]||this._mf.get(e);if(s&&this._tk(s,I),Array.isArray(e))for(const s of e)this._trv(s,t);else if(e instanceof Map||e instanceof Set)e.forEach(e=>this._trv(e,t));else for(const s in e)this._trv(e[s],t)}_clone(e,t=new Map){if(null===(e=this.toRaw(e))||"object"!=typeof e)return e;if(t.has(e))return t.get(e);if(e instanceof Date)return new Date(e);if(e instanceof RegExp)return new RegExp(e.source,e.flags);if(e instanceof Map){const s=new Map;return t.set(e,s),e.forEach((e,r)=>s.set(r,this._clone(e,t))),s}if(e instanceof Set){const s=new Set;return t.set(e,s),e.forEach(e=>s.add(this._clone(e,t))),s}if(Array.isArray(e)){const s=[];t.set(e,s);for(let r=0;r<e.length;r++)s[r]=this._clone(e[r],t);return s}const s={};t.set(e,s);for(const r in e)s[r]=this._clone(e[r],t);return s}_cls(e){return e?"string"==typeof e?e:Array.isArray(e)?e.map(e=>this._cls(e)).filter(Boolean).join(" "):"object"==typeof e?Object.keys(e).filter(t=>e[t]).join(" "):String(e):""}_sty(e){if(!e)return"";if("string"==typeof e)return e;if("object"==typeof e){let t="";for(const s in e){const r=e[s];null!=r&&!1!==r&&(t+=s+":"+r+";")}return t}return String(e)}_comp(e,t,s){const r=this._cp.get(t),i=r._t.cloneNode(!0),n=this._r({}),o=[],a=Object.create(null),l=Array.from(e.attributes);for(const e of l){const t=e.name,s=e.value;t.startsWith("@")?a[t.slice(1)]=this._fn(s,!0):t.startsWith(":")?o.push({name:t.slice(1),exp:s}):n[t]=s}for(const e of o)n[e.name]=this._fn(e.exp)(this.s,s);const h=(e,t)=>{i.dispatchEvent(new CustomEvent(e,{detail:t,bubbles:!0}));const r=a[e];r&&r(this.s,s,t)},p=Object.create(n);if(p.$props=n,p.$emit=h,r.s){const e=r.s(n,{emit:h,props:n,slots:{}});if(e&&"object"==typeof e)for(const t in e)p[t]=null!==e[t]&&"object"==typeof e[t]?this._r(e[t]):e[t]}const c=this._r(p);e.replaceWith(i);for(const e of o){const t=this._fn(e.exp),r=this._ef(()=>{n[e.name]=t(this.s,s)});this._reg(i,r.kill)}this._bnd(i,c),this._w(i,c)}}"undefined"!=typeof module?module.exports=Reflex:window.Reflex=Reflex;